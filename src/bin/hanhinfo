#!/bin/bash

set -e
set -o errtrace

trap func_exit EXIT

# Exit function
func_exit() {
printf "\n"
}


# Function for printing help
help() {
echo "hanhinfo - Hanh Linux installed packages search tool"
echo "Usage: hanhinfo [options] [package]"
echo "Options"
echo "--help                                    Print this message"
echo "--version                                 Print version"
echo "--config=<path to config>                 Use a alternative config"
echo "--type=[info,filelist]                    See type of information"
echo "--sysroot=<path>                          Change root directory"
echo "For any questions, please consider asking on GitHub: https://github.com/hanhlinux/pachanh"
exit
}

info() {
printf "\n>> $1"
}

err() {
printf "\n>>> $1" && exit 1
}

# Function for searching packages
search() {
for pkg in $package; do
### Check if the package is installed
 if [[ -d $infodir/$pkg ]]; then
### Check if the specified information file exists
  for file in $files; do
   [ ! -f $infodir/$pkg/$file ] && err "Specified file not found! Exiting..."
   info "Printing $file..."
   cat $infodir/$pkg/$file
  done
 else
  err "Package not found! Exiting..."
 fi
done
}

# Get the command line
command="$*"
[ -z "$command" ] && err "No package specified! Please use 'hanhinfo --help' for more information"

# Parse the command line
for x in $command; do

case $x in 
"--help") help;;
"--config"=*) 	config=$(echo "$x" | cut -d "=" -f2); source $config;;
"--type"=*) 	files=$(echo "$x" | cut -d "=" -f2 | sed 's/,/ /g');;
"--sysroot"=*) 	override_sysroot=$(echo "$x" | cut -d "=" -f2);;
"--version")    echo "$version";exit;;
--*) 		echo ">>> Unknown option: $x. Ignoring...";;
*) 		package="$package $x";;
esac

done

# Get some variables
[ ! -z "$config" ] && [ ! -f "$config" ] && err "Configuration file not found!" 
[ -z "$config" ] && config="CONFDIR/etc/hanh.conf"
source $config

if [ ! -z "$override_sysroot" ]; then 
 [ ! -d "$override_sysroot" ] && err "$override_sysroot not found!" && exit 1
 sysroot=$override_sysroot
fi
[ -z "$sysroot" ] && sysroot="SYSROOT/"

infodir="$sysroot/var/lib/pachanh/system/"
[ -z "$files" ] && files="info filelist header"

# Run the functions above
search
